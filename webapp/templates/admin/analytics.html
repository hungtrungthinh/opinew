{% extends 'admin/master.html' %}

{% block body %}

  <br><br>
  <h2>Analytics</h2>
  <table class="table">
    <tr>
      <th></th>
      <th></th>
      <th colspan="5" style="background-color: #8888ff">THE PIPELINE</th>
      <th colspan="3" style="background-color: #88ff88">AFTER OPINEW</th>
    </tr>
    <tr>
      <th>Shop</th>
      <th>Total Reviews</th>
      <th>Plugin Views</th>
      <th>Orders <br> with RR</th>
      <th>Emails <br>Sent</th>
      <th>Emails <br>Opened</th>
      <th>Emails <br>Converted</th>
      <th>Ver/Total<br>Reviews</th>
      <th>Opened/Total<br> Rev Reqs</th>
    </tr>
    {% for shop in shops %}
      {% set stats = shop.get_stats() %}
      <tr>
        <td>
          <h3>{{ shop.name }}</h3>
          <small>id: {{ shop.id }} | uid: {{ shop.owner.id if shop.owner else 0}} - cid: {{ shop.owner.customer[0].id if shop.owner and shop.owner.customer else 0 }}</small><br>
          <small>Since: {{ stats.since }}</small><br>
          <small>Products: {{ shop.products|length }}</small>
        </td>
        <td>
          <h3>{{ stats.reviews|length }}</h3>
          <small>
            {% for s in stats.reviews_cnt_by_product %}
              {{ s[1] }} w {{ s[0] }} rvs<br>
            {% endfor %}
          </small>
        </td>
        <td>
          <h3>{{ stats.funnel_streams_cnt }}</h3>
          <small>Glimpsed: {{ stats.funnel_streams_glimpsed_cnt }}</small><br>
        <small>Fully seen: {{ stats.funnel_streams_fully_seen_cnt }}</small><br>
        <small>Hovered: {{ stats.funnel_streams_hovered_cnt }}</small><br>
        <small>Scrolled: {{ stats.funnel_streams_scrolled_cnt }}</small><br>
        <small>Clicked: {{ stats.funnel_streams_clicked_cnt }}</small><br>
        </td>
        <td>
          <h3>{{ stats.orders_with_review_requests_cnt}}</h3>
        </td>
        <td>
          <h3>{{ stats.emails_sent_cnt }}</h3>
        </td>
        <td>
          <h3>{{ stats.emails_opened_cnt }}</h3>
          <small>{{ stats.emails_opened_over_sent_pctg }}%</small>
        </td>
        <td>
          <h3>{{ stats.emails_converted_cnt }}</h3>
          <small>{{ stats.emails_converted_over_emails_opened_pctg }}%</small>
        </td>
        <td>
          <h3>{{ stats.verified_opinew_reviews_cnt }} / {{ stats.opinew_total_reviews_cnt }}</h3>
          <small>{{ stats.verified_opinew_reviews_over_email_converted_pctg }}%</small><br>
        </td>
        <td>
          <h3>{{ stats.review_requests_opened_total_cnt }} / {{ stats.review_requests_cnt }}</h3>
        </td>
      </tr>
    {% endfor %}
  </table>
  <h2>Scheduled tasks</h2>
  <table class="table">
    <tr>
      <th>Task id</th>
      <th>Task ETA</th>
      <th>Kwargs</th>
      <th>Actions</th>
    </tr>
    {% for task in tasks %}
      <tr>
        <td>{{ task.request.id }}</td>
        <td>({{ task.eta }})</td>
        <td>{{ task.request.kwargs }}</td>
        <td><a href="/admin-revoke-task?task_id={{ task.request.id }}" class="btn btn-danger">Revoke task</a></td>
      </tr>
    {% endfor %}
  </table>
{% endblock %}